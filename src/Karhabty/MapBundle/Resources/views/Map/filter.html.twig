{% extends ':layout:LayoutUser.html.twig' %}

{% block content%}

	<div class="row">
	<div class="col-md-12">


		<div class="col-md-6">
		<div class="portlet-body">
			<div id="gmap_basic" class="gmaps">
			</div>


			</div>
		</div>

		<div class="col-md-6">
			<form>
			<label for="lavage">Lavage</label>
			<input type="checkbox"  data-toggle="toggle" value="lavage" id="lavage">
			<label>Auto-école</label>
			<input type="checkbox"  data-toggle="toggle" value="auto">
			<label>Mécanicien</label>
			<input type="checkbox"  data-toggle="toggle" value="mec">
			<label>Vendeur piéce de rechange</label>
			<input type="checkbox"  data-toggle="toggle" value="vendeur">
			</form>
		</div>







		<script type="text/javascript">
            var map;
            var latlng;
            var myResult;
            var marker;

            function initMap() {
                var directionsService = new google.maps.DirectionsService;
                var directionsDisplay = new google.maps.DirectionsRenderer({

                    suppressMarkers: true

				});
                var map = new google.maps.Map(document.getElementById('gmap_basic'), {
                    zoom: 7,
                    center: {lat: 36.84446074079564, lng: 10.111777782440186}
                });

                var markerPostion = new google.maps.Marker({
                    map: map,
                    title: 'Hello World!',
					icon:"{{ asset('assets/img/marker.png') }}"
                });

                directionsDisplay.setMap(map);


                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function(position) {
                        var pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };

                        markerPostion.setPosition(pos);
                        markerPostion.setMap(map);


                   //     var x= new google.maps.LatLng(36.83896555078597,10.20104169845581);

                     /*   var marker = new google.maps.Marker({
                            position: x,
                            map: map,
                            title: 'Hello World!'
                        });
*/

                     		var markers = [];

                        var activities_checked = [];
                        $('input:checkbox').change(
                            function(){
                                if ($(this).is(':checked')) {
                                    if($.inArray($(this).val(), activities_checked)<0)
                                    activities_checked.push($(this).val());
                                }else{
                                    var index = activities_checked.indexOf($(this).val());
                                    activities_checked.splice(index, 1);

								}
								console.log("active");


                                markers.forEach(function (item, index) {

                                    item.setMap(null);
                                });
                                markers = [];


                                putmarker();
                            });

						function putmarker() {
                            console.log("dude");


                            var h =[];
                          {%  for off in offres %}

						 	h.push(["{{ off[0] }}","{{ off[1] }}"]);
							{% endfor %}


                            h.forEach(function (item, index) {


						 var geocoder = new google.maps.Geocoder();
						 geocoder.geocode({address:item[0] }, function(results, status) {
						 if (status == google.maps.GeocoderStatus.OK) {

						 var myResult = results[0].geometry.location;

                             console.log($.inArray(item[1], activities_checked)>=0);
                             console.log(activities_checked);
                             console.log(item[1]);
                             if($.inArray(item[1], activities_checked)>=0) {

                              marker = new google.maps.Marker({
							 map: map,
							 position: myResult

							 });

                              markers.push(marker);


                                 map.setCenter(myResult);
                                 marker.setMap(map);
                                 // map.setZoom(17);


                             marker.addListener('click', function() {

                                 calculateAndDisplayRoute(directionsService, directionsDisplay,myResult,pos);

                             });

						 } }
						 });

                            });



                    }
                        putmarker();


                    }, function() {
                        handleLocationError(true, infoWindow, map.getCenter());
                    });
                } else {
                    // Browser doesn't support Geolocation
                    handleLocationError(false, infoWindow, map.getCenter());
                }






            }



            //handle location error

            function handleLocationError(browserHasGeolocation, infoWindow, pos) {
                infoWindow.setPosition(pos);
                infoWindow.setContent(browserHasGeolocation ?
                    'Error: The Geolocation service failed.' :
                    'Error: Your browser doesn\'t support geolocation.');


            }





            //calcule de la route

            function calculateAndDisplayRoute(directionsService, directionsDisplay,o, e) {
                directionsService.route({
                    origin: o,
                    destination:e,
                    travelMode: google.maps.TravelMode.DRIVING
                }, function(response, status) {
                    if (status === google.maps.DirectionsStatus.OK) {
                        directionsDisplay.setDirections(response);
                    } else {
                        window.alert('Directions request failed due to ' + status);
                    }
                });
            }


		</script>
		<script async defer
				src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAe4BNAZTQY-9JxbRhpgFUNuxjuyeGOZtU&callback=initMap">
		</script>






{% endblock %}